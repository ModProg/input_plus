import { Keypress, readKeypress } from "./keypress/mod.ts";

function isPrint(char: string) {
  // only needed until unicode category support is added for regex in Deno
  // /^\p{Alphabetic}$/u
  // Regex class from (added Space) https://util.unicode.org/UnicodeJsps/list-unicodeset.jsp?a=%5B%3Agc%3DLetter%3A%5D%5B%3Agc%3DMark%3A%5D%5B%3Agc%3DNumber%3A%5D%5B%3Agc%3DPunctuation%3A%5D%5B%3Agc%3DSymbol%3A%5D%0D%0A&abb=on&c=on&ucd=on&g=&i=
  const regex = /^[ -~Â¡-Â¬Â®-Í·Íº-Í¿Î„-ÎŠÎŒÎŽ-Î¡ Î£-Ô¯Ô±-Õ–Õ™-ÖŠÖ-ÖÖ‘-×‡×-×ª×¯-×´ Ø†-Ø›Øž-ÛœÛž-ÜÜ-ÝŠÝ-Þ±ß€-ßºß½-à ­ à °-à ¾à¡€-à¡›à¡žà¡ -à¡ªà¢ -à¢´à¢¶-à¢½à£“-à£¡à££-à¦ƒ à¦…-à¦Œà¦à¦à¦“-à¦¨à¦ª-à¦°à¦²à¦¶-à¦¹à¦¼-à§„à§‡à§ˆà§‹-à§Žà§— à§œà§à§Ÿ-à§£à§¦-à§¾à¨-à¨ƒà¨…-à¨Šà¨à¨à¨“-à¨¨à¨ª-à¨° à¨²à¨³à¨µà¨¶à¨¸à¨¹à¨¼à¨¾-à©‚à©‡à©ˆà©‹-à©à©‘à©™-à©œà©žà©¦-à©¶àª-àªƒ àª…-àªàª-àª‘àª“-àª¨àªª-àª°àª²àª³àªµ-àª¹àª¼-à«…à«‡-à«‰à«‹-à« à«à« -à«£à«¦-à«±à«¹-à«¿à¬-à¬ƒà¬…-à¬Œà¬à¬à¬“-à¬¨ à¬ª-à¬°à¬²à¬³à¬µ-à¬¹à¬¼-à­„à­‡à­ˆà­‹-à­à­–à­—à­œà­à­Ÿ-à­£ à­¦-à­·à®‚à®ƒà®…-à®Šà®Ž-à®à®’-à®•à®™à®šà®œà®žà®Ÿà®£à®¤ à®¨-à®ªà®®-à®¹à®¾-à¯‚à¯†-à¯ˆà¯Š-à¯à¯à¯—à¯¦-à¯ºà°€-à°Œ à°Ž-à°à°’-à°¨à°ª-à°¹à°½-à±„à±†-à±ˆà±Š-à±à±•à±–à±˜-à±š à± -à±£à±¦-à±¯à±·-à²Œà²Ž-à²à²’-à²¨à²ª-à²³à²µ-à²¹à²¼-à³„à³†-à³ˆà³Š-à³à³•à³– à³žà³ -à³£à³¦-à³¯à³±à³²à´€-à´ƒà´…-à´Œà´Ž-à´à´’-àµ„àµ†-àµˆàµŠ-àµ àµ”-àµ£àµ¦-àµ¿à¶‚à¶ƒà¶…-à¶–à¶š-à¶±à¶³-à¶»à¶½à·€-à·†à·Šà·-à·”à·–à·˜-à·Ÿ à·¦-à·¯à·²-à·´à¸-à¸ºà¸¿-à¹›àºàº‚àº„àº†-àºŠàºŒ-àº£ àº¥àº§-àº½à»€-à»„à»†à»ˆ-à»à»-à»™à»œ-à»Ÿà¼€-à½‡à½‰-à½¬à½±-à¾—à¾™-à¾¼ à¾¾-à¿Œà¿Ž-à¿šá€€-áƒ…áƒ‡áƒáƒ-á‰ˆá‰Š-á‰á‰-á‰–á‰˜ á‰š-á‰á‰ -áŠˆáŠŠ-áŠáŠ-áŠ°áŠ²-áŠµáŠ¸-áŠ¾á‹€á‹‚-á‹… á‹ˆ-á‹–á‹˜-áŒáŒ’-áŒ•áŒ˜-ášá-á¼áŽ€-áŽ™áŽ -áµ á¸-á½á€-á™¿áš-ášœáš -á›¸áœ€-áœŒáœŽ-áœ”áœ -áœ¶ á€-á“á -á¬á®-á°á²á³áž€-áŸáŸ -áŸ©áŸ°-áŸ¹á €-á -á ™ á  -á¡¸á¢€-á¢ªá¢°-á£µá¤€-á¤žá¤ -á¤«á¤°-á¤»á¥€á¥„-á¥­ á¥°-á¥´á¦€-á¦«á¦°-á§‰á§-á§šá§ž-á¨›á¨ž-á©žá© -á©¼á©¿-áª‰ áª-áª™áª -áª­áª°-áª¾á¬€-á­‹á­-á­¼á®€-á¯³á¯¼-á°· á°»-á±‰á±-á²ˆá²-á²ºá²½-á³‡á³-á³ºá´€-á·¹á·»-á¼• á¼˜-á¼á¼ -á½…á½ˆ-á½á½-á½—á½™á½›á½á½Ÿ-á½½á¾€-á¾´ á¾¶-á¿„á¿†-á¿“á¿–-á¿›á¿-á¿¯á¿²-á¿´á¿¶-á¿¾â€-â€§ â€°-âžâ°â±â´-â‚Žâ‚-â‚œâ‚ -â‚¿âƒ-âƒ°â„€-â†‹â†-â¦ â‘€-â‘Šâ‘ -â­³â­¶-â®•â®˜-â°®â°°-â±žâ± -â³³â³¹-â´¥ â´§â´­â´°-âµ§âµ¯âµ°âµ¿-â¶–â¶ -â¶¦â¶¨-â¶®â¶°-â¶¶â¶¸-â¶¾ â·€-â·†â·ˆ-â·Žâ·-â·–â·˜-â·žâ· -â¹âº€-âº™âº›-â»³ â¼€-â¿•â¿°-â¿»ã€-ã€¿ã-ã‚–ã‚™-ãƒ¿ã„…-ã„¯ã„±-ã†Ž ã†-ã†ºã‡€-ã‡£ã‡°-ãˆžãˆ -ã‹¾ãŒ€-ä¶µä·€-é¿¯ê€€-ê’Œ ê’-ê“†ê“-ê˜«ê™€-ê›·êœ€-êž¿êŸ‚-êŸ†êŸ·-ê «ê °-ê ¹ ê¡€-ê¡·ê¢€-ê£…ê£Ž-ê£™ê£ -ê¥“ê¥Ÿ-ê¥¼ê¦€-ê§ê§-ê§™ ê§ž-ê§¾ê¨€-ê¨¶ê©€-ê©ê©-ê©™ê©œ-ê«‚ê«›-ê«¶ê¬-ê¬† ê¬‰-ê¬Žê¬‘-ê¬–ê¬ -ê¬¦ê¬¨-ê¬®ê¬°-ê­§ê­°-ê¯­ê¯°-ê¯¹ ê°€-íž£íž°-íŸ†íŸ‹-íŸ»ï¤€-ï©­ï©°-ï«™ï¬€-ï¬†ï¬“-ï¬— ï¬-ï¬¶ï¬¸-ï¬¼ï¬¾ï­€ï­ï­ƒï­„ï­†-ï¯ï¯“-ï´¿ïµ-ï¶ï¶’-ï·‡ ï·°-ï·½-ï¸™ï¸ -ï¹’ï¹”-ï¹¦ï¹¨-ï¹«ï¹°-ï¹´ï¹¶-ï»¼ï¼-ï¾¾ ï¿‚-ï¿‡ï¿Š-ï¿ï¿’-ï¿—ï¿š-ï¿œï¿ -ï¿¦ï¿¨-ï¿®ï¿¼ï¿½ð€€-ð€‹ ð€-ð€¦ð€¨-ð€ºð€¼ð€½ð€¿-ðð-ðð‚€-ðƒºð„€-ð„‚ð„‡-ð„³ ð„·-ð†Žð†-ð†›ð† ð‡-ð‡½ðŠ€-ðŠœðŠ -ð‹ð‹ -ð‹»ðŒ€-ðŒ£ ðŒ­-ðŠð-ðºðŽ€-ðŽðŽŸ-ðƒðˆ-ð•ð€-ð’ð’ -ð’© ð’°-ð““ð“˜-ð“»ð”€-ð”§ð”°-ð•£ð•¯ð˜€-ðœ¶ð€-ð•ð -ð§ ð €-ð …ð ˆð Š-ð µð ·ð ¸ð ¼ð ¿-ð¡•ð¡—-ð¢žð¢§-ð¢¯ð£ -ð£² ð£´ð£µð£»-ð¤›ð¤Ÿ-ð¤¹ð¤¿ð¦€-ð¦·ð¦¼-ð§ð§’-ð¨ƒð¨…ð¨†ð¨Œ-ð¨“ ð¨•-ð¨—ð¨™-ð¨µð¨¸-ð¨ºð¨¿-ð©ˆð©-ð©˜ð© -ðªŸð«€-ð«¦ ð««-ð«¶ð¬€-ð¬µð¬¹-ð­•ð­˜-ð­²ð­¸-ð®‘ð®™-ð®œð®©-ð®¯ ð°€-ð±ˆð²€-ð²²ð³€-ð³²ð³º-ð´§ð´°-ð´¹ð¹ -ð¹¾ð¼€-ð¼§ ð¼°-ð½™ð¿ -ð¿¶ð‘€€-ð‘ð‘’-ð‘¯ð‘¿-ð‘‚¼ð‘‚¾-ð‘ƒð‘ƒ-ð‘ƒ¨ ð‘ƒ°-ð‘ƒ¹ð‘„€-ð‘„´ð‘„¶-ð‘…†ð‘…-ð‘…¶ð‘†€-ð‘‡ð‘‡-ð‘‡Ÿð‘‡¡-ð‘‡´ ð‘ˆ€-ð‘ˆ‘ð‘ˆ“-ð‘ˆ¾ð‘Š€-ð‘Š†ð‘Šˆð‘ŠŠ-ð‘Šð‘Š-ð‘Šð‘ŠŸ-ð‘Š©ð‘Š°-ð‘‹ª ð‘‹°-ð‘‹¹ð‘Œ€-ð‘Œƒð‘Œ…-ð‘ŒŒð‘Œð‘Œð‘Œ“-ð‘Œ¨ð‘Œª-ð‘Œ°ð‘Œ²ð‘Œ³ð‘Œµ-ð‘Œ¹ð‘Œ»-ð‘„ð‘‡ð‘ˆð‘‹-ð‘ ð‘ð‘—ð‘-ð‘£ð‘¦-ð‘¬ð‘°-ð‘´ð‘€-ð‘‘™ð‘‘›ð‘‘-ð‘‘Ÿð‘’€-ð‘“‡ ð‘“-ð‘“™ð‘–€-ð‘–µð‘–¸-ð‘—ð‘˜€-ð‘™„ð‘™-ð‘™™ð‘™ -ð‘™¬ð‘š€-ð‘š¸ ð‘›€-ð‘›‰ð‘œ€-ð‘œšð‘œ-ð‘œ«ð‘œ°-ð‘œ¿ð‘ €-ð‘ »ð‘¢ -ð‘£²ð‘£¿ð‘¦ -ð‘¦§ ð‘¦ª-ð‘§—ð‘§š-ð‘§¤ð‘¨€-ð‘©‡ð‘©-ð‘ª¢ð‘«€-ð‘«¸ð‘°€-ð‘°ˆð‘°Š-ð‘°¶ð‘°¸-ð‘±… ð‘±-ð‘±¬ð‘±°-ð‘²ð‘²’-ð‘²§ð‘²©-ð‘²¶ð‘´€-ð‘´†ð‘´ˆð‘´‰ð‘´‹-ð‘´¶ð‘´ºð‘´¼ð‘´½ð‘´¿-ð‘µ‡ ð‘µ-ð‘µ™ð‘µ -ð‘µ¥ð‘µ§ð‘µ¨ð‘µª-ð‘¶Žð‘¶ð‘¶‘ð‘¶“-ð‘¶˜ð‘¶ -ð‘¶©ð‘» -ð‘»¸ ð‘¿€-ð‘¿±ð‘¿¿-ð’Ž™ð’€-ð’‘®ð’‘°-ð’‘´ð’’€-ð’•ƒð“€€-ð“®ð”€-ð”™† ð– €-ð–¨¸ð–©€-ð–©žð–© -ð–©©ð–©®ð–©¯ð–«-ð–«­ð–«°-ð–«µð–¬€-ð–­…ð–­-ð–­™ ð–­›-ð–­¡ð–­£-ð–­·ð–­½-ð–®ð–¹€-ð–ºšð–¼€-ð–½Šð–½-ð–¾‡ð–¾-ð–¾Ÿ ð–¿ -ð–¿£ð—€€-ð˜Ÿ·ð˜ €-ð˜«²ð›€€-ð›„žð›…-ð›…’ð›…¤-ð›…§ð›…°-ð›‹» ð›°€-ð›±ªð›±°-ð›±¼ð›²€-ð›²ˆð›²-ð›²™ð›²œ-ð›²Ÿð€€-ðƒµð„€-ð„¦ ð„©-ð…²ð…»-ð‡¨ðˆ€-ð‰…ð‹ -ð‹³ðŒ€-ð–ð -ð¸ð€-ð‘” ð‘–-ð’œð’žð’Ÿð’¢ð’¥ð’¦ð’©-ð’¬ð’®-ð’¹ð’»ð’½-ð“ƒð“…-ð”… ð”‡-ð”Šð”-ð””ð”–-ð”œð”ž-ð”¹ð”»-ð”¾ð•€-ð•„ð•†ð•Š-ð• ð•’-ðš¥ðš¨-ðŸ‹ðŸŽ-ðª‹ðª›-ðªŸðª¡-ðª¯ðž€€-ðž€†ðž€ˆ-ðž€˜ðž€›-ðž€¡ðž€£ðž€¤ðž€¦-ðž€ª ðž„€-ðž„¬ðž„°-ðž„½ðž…€-ðž…‰ðž…Žðž…ðž‹€-ðž‹¹ðž‹¿ðž €-ðž£„ðž£‡-ðž£– ðž¤€-ðž¥‹ðž¥-ðž¥™ðž¥žðž¥Ÿðž±±-ðž²´ðž´-ðž´½ðž¸€-ðž¸ƒðž¸…-ðž¸Ÿðž¸¡ ðž¸¢ðž¸¤ðž¸§ðž¸©-ðž¸²ðž¸´-ðž¸·ðž¸¹ðž¸»ðž¹‚ðž¹‡ðž¹‰ðž¹‹ðž¹-ðž¹ðž¹‘ðž¹’ðž¹” ðž¹—ðž¹™ðž¹›ðž¹ðž¹Ÿðž¹¡ðž¹¢ðž¹¤ðž¹§-ðž¹ªðž¹¬-ðž¹²ðž¹´-ðž¹·ðž¹¹-ðž¹¼ðž¹¾ ðžº€-ðžº‰ðžº‹-ðžº›ðžº¡-ðžº£ðžº¥-ðžº©ðžº«-ðžº»ðž»°ðž»±ðŸ€€-ðŸ€«ðŸ€°-ðŸ‚“ ðŸ‚ -ðŸ‚®ðŸ‚±-ðŸ‚¿ðŸƒ-ðŸƒðŸƒ‘-ðŸƒµðŸ„€-ðŸ„ŒðŸ„-ðŸ…¬ðŸ…°-ðŸ†¬ðŸ‡¦-ðŸˆ‚ ðŸˆ-ðŸˆ»ðŸ‰€-ðŸ‰ˆðŸ‰ðŸ‰‘ðŸ‰ -ðŸ‰¥ðŸŒ€-ðŸ›•ðŸ› -ðŸ›¬ðŸ›°-ðŸ›ºðŸœ€-ðŸ³ ðŸž€-ðŸŸ˜ðŸŸ -ðŸŸ«ðŸ €-ðŸ ‹ðŸ -ðŸ¡‡ðŸ¡-ðŸ¡™ðŸ¡ -ðŸ¢‡ðŸ¢-ðŸ¢­ ðŸ¤€-ðŸ¤‹ðŸ¤-ðŸ¥±ðŸ¥³-ðŸ¥¶ðŸ¥º-ðŸ¦¢ðŸ¦¥-ðŸ¦ªðŸ¦®-ðŸ§ŠðŸ§-ðŸ©“ ðŸ© -ðŸ©­ðŸ©°-ðŸ©³ðŸ©¸-ðŸ©ºðŸª€-ðŸª‚ðŸª-ðŸª•ð €€-ðª›–ðªœ€-ð«œ´ ð«€-ð« ð«  -ð¬º¡ð¬º°-ð®¯ ð¯ €-ð¯¨-]$/u;
  return regex.test(char);
}


export async function readInput({
  stdin = Deno.stdin,
  stdout = Deno.stdout,
  prefix = "",
  valid = isPrint,
  endInput = ["return", "\x03", "\x04"],
  highlighter = (input: string) => input,
  tabcompleter = (input: string) => input,
} = {}): Promise<[string, Keypress | undefined]> {
  const encoder = new TextEncoder();
  const minCursor = prefix.length + 1;
  var lines: string[] = [];
  var input = "";
  var cursor = minCursor;
  stdout.write(encoder.encode(prefix));
  for await (const keypress of readKeypress(stdin)) {
    switch (keypress.key) {
      case "up":
      case "down":
        continue;
      //deno-lint-ignore no-fallthrough
      case "backspace":
        input =
          input.substring(0, cursor - minCursor - 1) +
          input.substring(cursor - minCursor);
      case "left":
        cursor = cursor <= minCursor ? minCursor : cursor - 1;
        break;
      case "right":
        cursor =
          cursor >= minCursor + input.length
            ? minCursor + input.length
            : cursor + 1;
        break;
      case "delete":
        input =
          input.substring(0, cursor - minCursor) +
          input.substring(cursor + 1 - minCursor);
        break;
      case "return":
        if (!endInput.includes("return") && !endInput.includes("\r")) {
          lines.push(input);
          input = "";
          cursor = minCursor;
          stdout.write(encoder.encode("\n"));
        }
        break;
      default:
        if (
          !(keypress.ctrlKey || keypress.metaKey) &&
          keypress.key &&
          valid(keypress.sequence)
        ) {
          input =
            input.substring(0, cursor - minCursor) +
            keypress.sequence +
            input.substring(cursor - minCursor);
          cursor++;
        }
    }
    await stdout.write(
      encoder.encode(`\r\u001B[2K${prefix}${input}\u001B[${cursor}G`)
    );
    if (
      endInput.includes(keypress.sequence) ||
      (keypress.key && endInput.includes(keypress.key))
    ) {
      await stdout.write(encoder.encode("\n"));
      if (input.length > 0 || lines.length == 0) lines.push(input);
      return [lines.join("\n"), keypress];
    }
  }
  throw "You should not be able to get here";
}
